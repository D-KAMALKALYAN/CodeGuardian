import React from 'react';
import {
  Card,
  CardContent,
  CardActions,
  Typography,
  Chip,
  IconButton,
  Box,
  Collapse,
  useTheme,
  alpha,
  Divider,
  Tooltip,
  useMediaQuery
} from '@mui/material';
import BookmarkBorderIcon from '@mui/icons-material/BookmarkBorder';
import BookmarkIcon from '@mui/icons-material/Bookmark';
import ExpandMoreIcon from '@mui/icons-material/ExpandMore';
import CodeIcon from '@mui/icons-material/Code';
import SecurityIcon from '@mui/icons-material/Security';
import LaunchIcon from '@mui/icons-material/Launch';

const VulnerabilityCard = ({ vulnerability, isBookmarked, onToggleBookmark }) => {
  const theme = useTheme();
  const [expanded, setExpanded] = React.useState(false);
  const isMobile = useMediaQuery(theme.breakpoints.down('sm'));

  const handleExpandClick = () => {
    setExpanded(!expanded);
  };

  // Handler for bookmark toggle
  const handleToggleLike = (e) => {
    e.stopPropagation();
    if (onToggleBookmark) {
      onToggleBookmark(vulnerability.id);
    }
  };

  // Determine card border color based on severity
  const getSeverityColor = (severity) => {
    switch (severity) {
      case 'Critical':
        return theme.palette.error.main;
      case 'High':
        return theme.palette.warning.main;
      case 'Medium':
        return theme.palette.info.main;
      case 'Low':
        return theme.palette.success.main;
      default:
        return theme.palette.grey[400];
    }
  };

  const borderColor = getSeverityColor(vulnerability.severity);

  // Format CWE display with better handling for missing values
  const renderCweInfo = () => {
    if (vulnerability.cweId) {
      return (
        <Tooltip title={`Common Weakness Enumeration ID: ${vulnerability.cweId}`}>
          <Chip 
            icon={<CodeIcon fontSize="small" />}
            label={`CWE-${vulnerability.cweId}`}
            size="small"
            variant="outlined"
            sx={{ 
              fontSize: '0.75rem',
              borderRadius: '16px',
              background: alpha(theme.palette.primary.main, 0.1),
              borderColor: alpha(theme.palette.primary.main, 0.5),
              transition: 'all 0.2s ease',
              '&:hover': {
                background: alpha(theme.palette.primary.main, 0.2),
                transform: 'translateY(-2px)'
              }
            }}
            component="a"
            href={`https://cwe.mitre.org/data/definitions/${vulnerability.cweId}.html`}
            target="_blank"
            rel="noopener noreferrer"
            clickable
          />
        </Tooltip>
      );
    } else {
      return (
        <Tooltip title="Learn more about common vulnerabilities">
          <Chip 
            icon={<SecurityIcon fontSize="small" />}
            label="Learn More"
            size="small"
            variant="outlined"
            sx={{ 
              fontSize: '0.75rem',
              borderRadius: '16px',
              background: alpha(theme.palette.secondary.main, 0.1),
              borderColor: alpha(theme.palette.secondary.main, 0.5),
              transition: 'all 0.2s ease',
              '&:hover': {
                background: alpha(theme.palette.secondary.main, 0.2),
                transform: 'translateY(-2px)'
              }
            }}
            component="a"
            href="https://owasp.org/www-community/vulnerabilities/"
            target="_blank"
            rel="noopener noreferrer"
            clickable
          />
        </Tooltip>
      );
    }
  };

  return (
    <Card 
      sx={{ 
        height: '100%',
        display: 'flex',
        flexDirection: 'column',
        transition: 'all 0.3s ease-in-out',
        borderRadius: '12px',
        borderLeft: `4px solid ${borderColor}`,
        backdropFilter: 'none',
        background: alpha(theme.palette.background.paper, 0.8),
        boxShadow: theme.palette.mode === 'dark' 
          ? `0 8px 16px rgba(0, 0, 0, 0.5), inset 0 0 0 1px ${alpha(borderColor, 0.2)}`
          : `0 8px 16px ${alpha(theme.palette.primary.main, 0.1)}, inset 0 0 0 1px ${alpha(borderColor, 0.2)}`,
        '&:hover': {
          transform: 'translateY(-6px)',
          boxShadow: theme.palette.mode === 'dark'
            ? `0 12px 20px rgba(0, 0, 0, 0.7), inset 0 0 0 1px ${alpha(borderColor, 0.3)}, 0 0 15px ${alpha(borderColor, 0.3)}`
            : `0 12px 20px ${alpha(theme.palette.primary.main, 0.15)}, inset 0 0 0 1px ${alpha(borderColor, 0.3)}, 0 0 15px ${alpha(borderColor, 0.2)}`,
        },
        cursor: 'pointer',
        position: 'relative',
        overflow: 'visible'
      }}
      elevation={0}
      onClick={handleExpandClick}
    >
      {/* Severity indicator with glow effect */}
      <Box 
        sx={{
          position: 'absolute',
          left: -2,
          top: '10%',
          height: '80%',
          width: '4px',
          borderRadius: '4px',
          background: borderColor,
          boxShadow: `0 0 10px ${alpha(borderColor, 0.6)}`,
          zIndex: 1
        }}
      />
      
      <CardContent sx={{ p: isMobile ? 2 : 3, pb: 1, flexGrow: 1 }}>
        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', mb: 1 }}>
          <Typography 
            variant="h6" 
            component="h2" 
            fontWeight="600"
            gutterBottom
            sx={{
              fontSize: isMobile ? '1rem' : '1.1rem',
              background: theme.palette.mode === 'dark' 
                ? `linear-gradient(135deg, #fff 0%, ${alpha(theme.palette.primary.main, 0.8)} 100%)` 
                : `linear-gradient(135deg, ${theme.palette.text.primary} 0%, ${theme.palette.primary.main} 100%)`,
              WebkitBackgroundClip: 'text',
              WebkitTextFillColor: 'transparent',
              letterSpacing: '0.5px'
            }}
          >
            {vulnerability.title}
          </Typography>
          <IconButton 
            onClick={handleToggleLike}
            color="primary"
            sx={{ 
              p: 0.5, 
              ml: 0.5,
              background: alpha(theme.palette.background.paper, 0.3),
              backdropFilter: 'none',
              border: `1px solid ${alpha(theme.palette.primary.main, 0.2)}`,
              transition: 'all 0.2s ease',
              '&:hover': {
                background: alpha(theme.palette.primary.main, 0.1)
              },
              fontSize: isMobile ? '0.9rem' : '1rem'
            }}
            aria-label={isBookmarked ? "Remove bookmark" : "Add bookmark"}
          >
            {isBookmarked ? 
              <BookmarkIcon sx={{ color: theme.palette.primary.main }} /> : 
              <BookmarkBorderIcon />
            }
          </IconButton>
        </Box>

        <Box sx={{ display: 'flex', gap: 1, flexWrap: 'wrap', mb: 2 }}>
          {vulnerability.severity && (
            <Chip 
              label={vulnerability.severity} 
              size="small" 
              sx={{ 
                backgroundColor: alpha(getSeverityColor(vulnerability.severity), theme.palette.mode === 'dark' ? 0.2 : 0.1),
                color: theme.palette.mode === 'dark' ? alpha(getSeverityColor(vulnerability.severity), 0.9) : getSeverityColor(vulnerability.severity),
                fontWeight: 'bold',
                borderRadius: '8px',
                fontSize: '0.75rem',
                border: `1px solid ${alpha(getSeverityColor(vulnerability.severity), 0.3)}`,
                boxShadow: `0 0 10px ${alpha(getSeverityColor(vulnerability.severity), 0.1)}`
              }}
            />
          )}
          {vulnerability.category && (
            <Chip 
              label={vulnerability.category} 
              size="small"
              variant="outlined"
              sx={{ 
                borderColor: alpha(theme.palette.grey[500], 0.3),
                borderRadius: '8px',
                fontSize: '0.75rem',
                backdropFilter: 'none',
              }}
            />
          )}
        </Box>

        <Typography 
          variant="body2" 
          color="text.secondary" 
          sx={{ 
            mb: 1,
            fontSize: isMobile ? '0.8rem' : '0.875rem',
            lineHeight: 1.6,
            opacity: 0.9
          }}
        >
          {vulnerability.description.length > (isMobile ? 80 : 120)
            ? `${vulnerability.description.substring(0, isMobile ? 80 : 120)}...`
            : vulnerability.description}
        </Typography>
      </CardContent>

      <CardActions 
        sx={{ 
          p: isMobile ? 1 : 2, 
          pt: 0, 
          justifyContent: 'space-between',
          borderTop: `1px solid ${alpha(theme.palette.divider, 0.08)}`
        }}
      >
        <Box sx={{ display: 'flex', alignItems: 'center' }}>
          {renderCweInfo()}
        </Box>
        
        <IconButton
          aria-expanded={expanded}
          aria-label="show more"
          sx={{
            transform: expanded ? 'rotate(180deg)' : 'rotate(0deg)',
            transition: theme.transitions.create('transform', {
              duration: theme.transitions.duration.shortest,
            }),
            background: alpha(theme.palette.primary.main, expanded ? 0.15 : 0.05),
            backdropFilter: 'none',
            border: `1px solid ${alpha(theme.palette.primary.main, 0.2)}`,
            '&:hover': {
              background: alpha(theme.palette.primary.main, 0.2)
            },
            width: '32px',
            height: '32px'
          }}
        >
          <ExpandMoreIcon fontSize="small" />
        </IconButton>
      </CardActions>
      
      <Collapse in={expanded} timeout="auto" unmountOnExit>
        <Divider sx={{ opacity: 0.5, mx: 2 }} />
        <CardContent 
          sx={{ 
            p: isMobile ? 2 : 3, 
            pt: isMobile ? 1.5 : 2, 
            bgcolor: alpha(theme.palette.background.default, 0.4),
            backdropFilter: 'none'
          }}
        >
          <Typography 
            paragraph 
            variant="body2" 
            sx={{ 
              lineHeight: 1.7,
              fontSize: isMobile ? '0.8rem' : '0.875rem'
            }}
          >
            {vulnerability.description}
          </Typography>
          
          {vulnerability.example && (
            <>
              <Typography 
                variant="subtitle2" 
                fontWeight="bold" 
                sx={{ 
                  mt: 2,
                  mb: 0.5,
                  display: 'flex',
                  alignItems: 'center',
                  color: theme.palette.primary.main,
                  fontSize: isMobile ? '0.85rem' : '0.9rem'
                }}
              >
                <CodeIcon sx={{ mr: 0.5, fontSize: isMobile ? '1rem' : '1.1rem' }} />
                Example:
              </Typography>
              <Typography 
                variant="body2" 
                component="div" 
                sx={{
                  backgroundColor: alpha(theme.palette.mode === 'dark' ? theme.palette.common.black : theme.palette.grey[100], 0.7),
                  p: 1.5,
                  borderRadius: '8px',
                  mt: 0.5,
                  fontFamily: '"JetBrains Mono", monospace',
                  fontSize: isMobile ? '0.75rem' : '0.85rem',
                  whiteSpace: 'pre-wrap',
                  overflowX: 'auto',
                  border: `1px solid ${alpha(theme.palette.divider, 0.1)}`,
                  boxShadow: `inset 0 0 20px ${alpha(theme.palette.common.black, 0.05)}`,
                  position: 'relative'
                }}
              >
                {vulnerability.example}
              </Typography>
            </>
          )}
          
          {vulnerability.mitigation && (
            <>
              <Typography 
                variant="subtitle2" 
                fontWeight="bold" 
                sx={{ 
                  mt: 2.5,
                  mb: 0.5,
                  display: 'flex',
                  alignItems: 'center',
                  color: theme.palette.secondary.main,
                  fontSize: isMobile ? '0.85rem' : '0.9rem'
                }}
              >
                <SecurityIcon sx={{ mr: 0.5, fontSize: isMobile ? '1rem' : '1.1rem' }} />
                Mitigation:
              </Typography>
              <Typography 
                variant="body2" 
                paragraph 
                sx={{ 
                  mt: 0.5, 
                  fontSize: isMobile ? '0.8rem' : '0.875rem',
                  p: 1.5,
                  backgroundColor: alpha(theme.palette.success.main, 0.05),
                  borderRadius: '8px',
                  border: `1px solid ${alpha(theme.palette.success.main, 0.1)}`,
                  lineHeight: 1.7
                }}
              >
                {vulnerability.mitigation}
              </Typography>
            </>
          )}

          {vulnerability.cweId ? (
            <>
              <Typography 
                variant="subtitle2" 
                fontWeight="bold" 
                sx={{ 
                  mt: 2.5,
                  mb: 1,
                  fontSize: isMobile ? '0.85rem' : '0.9rem'
                }}
              >
                CWE Information:
              </Typography>
              <Box 
                sx={{ 
                  mt: 0.5, 
                  display: 'flex', 
                  alignItems: 'center', 
                  gap: 1,
                  flexWrap: 'wrap' 
                }}
              >
                <Typography 
                  variant="body2"
                  sx={{ fontSize: isMobile ? '0.8rem' : '0.875rem' }}
                >
                  Learn more about CWE-{vulnerability.cweId}:
                </Typography>
                <Chip
                  icon={<LaunchIcon fontSize="small" />}
                  label="View CWE Details"
                  size="small"
                  color="primary"
                  variant="outlined"
                  component="a"
                  href={`https://cwe.mitre.org/data/definitions/${vulnerability.cweId}.html`}
                  target="_blank"
                  rel="noopener noreferrer"
                  clickable
                  sx={{ 
                    fontSize: '0.75rem',
                    borderRadius: '20px',
                    transition: 'all 0.2s ease',
                    background: alpha(theme.palette.primary.main, 0.1),
                    '&:hover': {
                      background: alpha(theme.palette.primary.main, 0.2),
                      transform: 'translateY(-2px)',
                      boxShadow: `0 4px 8px ${alpha(theme.palette.primary.main, 0.2)}`
                    }
                  }}
                />
              </Box>
            </>
          ) : (
            <>
              <Typography 
                variant="subtitle2" 
                fontWeight="bold" 
                sx={{ 
                  mt: 2.5,
                  mb: 1,
                  fontSize: isMobile ? '0.85rem' : '0.9rem'
                }}
              >
                Learn More:
              </Typography>
              <Box 
                sx={{ 
                  mt: 0.5, 
                  display: 'flex', 
                  alignItems: 'center', 
                  gap: 1,
                  flexWrap: 'wrap'
                }}
              >
                <Typography 
                  variant="body2"
                  sx={{ fontSize: isMobile ? '0.8rem' : '0.875rem' }}
                >
                  Explore common security vulnerabilities:
                </Typography>
                <Chip
                  icon={<LaunchIcon fontSize="small" />}
                  label="OWASP Vulnerabilities"
                  size="small"
                  color="secondary"
                  variant="outlined"
                  component="a"
                  href="https://owasp.org/www-community/vulnerabilities/"
                  target="_blank"
                  rel="noopener noreferrer"
                  clickable
                  sx={{ 
                    fontSize: '0.75rem',
                    borderRadius: '20px',
                    transition: 'all 0.2s ease',
                    background: alpha(theme.palette.secondary.main, 0.1),
                    '&:hover': {
                      background: alpha(theme.palette.secondary.main, 0.2),
                      transform: 'translateY(-2px)',
                      boxShadow: `0 4px 8px ${alpha(theme.palette.secondary.main, 0.2)}`
                    }
                  }}
                />
              </Box>
            </>
          )}
        </CardContent>
      </Collapse>
    </Card>
  );
};

export default VulnerabilityCard;